(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){module.exports=function(){const SECONDS_IN_HOUR=3600,BORDER=20,MILE_PER_KM=.6213712,KM_PER_MILE=1.609344,KM_PER_METER=.001,MILE_PER_FT=18939e-8,FT_PER_METER=3.2808399,METER_PER_FT=.3048;return{geometricDegreesToGeographic:function(degrees){if(degrees<0){degrees+=360}return(450-degrees)%360},heading:function(a,b){var radians=Math.atan2(b.lat-a.lat,b.lng-a.lng);var degrees=radians*180/Math.PI;degrees=this.geometricDegreesToGeographic(degrees);return degrees},midpoint:function(a,b){var lat=(a.lat+b.lat)/2;var lng=(a.lng+b.lng)/2;return L.latLng(lat,lng)},pad:function(num,size){var s=Math.floor(num).toFixed(0);while(s.length<size){s="0"+s}return s},time:function(speed,distance){var kmPerSecond=speed/SECONDS_IN_HOUR;return distance/kmPerSecond},maxBounds:function(mapConfig){return[[mapConfig.latMin-BORDER,mapConfig.lngMin-BORDER],[mapConfig.latMax+BORDER,mapConfig.lngMax+BORDER]]},tileBounds:function(mapConfig){return[[mapConfig.latMin,mapConfig.lngMin],[mapConfig.latMax,mapConfig.lngMax]]},center:function(mapConfig){return[(Math.abs(mapConfig.latMax)-Math.abs(mapConfig.latMin))/2,(Math.abs(mapConfig.lngMax)-Math.abs(mapConfig.lngMin))/2]},gridLatLng:function(grid,mapConfig){var width=mapConfig.lngMax-mapConfig.lngMin;var height=mapConfig.latMax-mapConfig.latMin;var gridWidth=width/mapConfig.lngGridMax;var gridHeight=height/mapConfig.latGridMax;var gridSideLength=(gridWidth+gridHeight)/2;var gridLat=parseInt(grid.substring(0,2));var gridLng=parseInt(grid.substring(2,4));var lat=mapConfig.latMax-gridLat*gridSideLength;var lng=gridLng*gridSideLength;return[lat,lng]},invertHeading:function(heading){return(360+(heading-180))%360},convertSpeed:function(value,units){var factor=units==="metric"?KM_PER_MILE:MILE_PER_KM;return Math.round(value*factor)},convertDistance:function(value,units){var factor=units==="metric"?KM_PER_MILE:MILE_PER_KM;return(value*factor).toFixed(4)},convertAltitude:function(value,units){var factor=units==="metric"?METER_PER_FT:FT_PER_METER;return(value*factor).toFixed(2)},altitudeUnitAdjust:function(value,units){var factor=units==="metric"?KM_PER_METER:MILE_PER_FT;return(value*factor).toFixed(4)}}}()},{}],2:[function(require,module,exports){module.exports=function(){var conf=JSON.parse('{\n  "apiUrl"    : "NONE",\n  "serverUrl" : "https://www.example.com",\n  "tilesUrl"  : "https://www.example.com/tiles",\n  "streaming" : false,\n  "webdisUrl" : "https://www.example.com/WEBDIS"\n}');var mapConfigs={stalingrad:{fullName:"Stalingrad",name:"stalingrad",hash:"#stalingrad",selectIndex:0,scale:1.40056,oldLatFixFactor:-.2,latMin:-164,latMax:0,latGridMax:23,lngMin:0,lngMax:252,lngGridMax:37,gridHopZoom:5,defaultZoom:3,minZoom:2,maxZoom:6,tileUrl:conf.tilesUrl+"/stalingrad/{z}/{x}/{y}.png"},moscow:{fullName:"Moscow",name:"moscow",hash:"#moscow",selectIndex:1,scale:1.46621,oldLatFixFactor:0,latMin:-192,latMax:0,latGridMax:29,lngMin:0,lngMax:192,lngGridMax:29,gridHopZoom:5,defaultZoom:3,minZoom:2,maxZoom:6,tileUrl:conf.tilesUrl+"/moscow/{z}/{x}/{y}.png"},luki:{fullName:"Velikie Luki",name:"luki",hash:"#luki",selectIndex:2,scale:.65306,oldLatFixFactor:0,latMin:-160,latMax:0,latGridMax:10.4,lngMin:0,lngMax:254,lngGridMax:17.6,gridHopZoom:4,defaultZoom:3,minZoom:2,maxZoom:6,tileUrl:conf.tilesUrl+"/luki/{z}/{x}/{y}.png"},kuban:{fullName:"Kuban",name:"kuban",hash:"#kuban",selectIndex:3,scale:2.876397232,oldLatFixFactor:3.06,latMin:-103,latMax:0,latGridMax:29.7,lngMin:0,lngMax:148,lngGridMax:42.5,gridHopZoom:6,defaultZoom:4,minZoom:2,maxZoom:7,tileUrl:conf.tilesUrl+"/kuban/{z}/{x}/{y}.png"},rheinland:{fullName:"Rheinland",name:"rheinland",hash:"#rheinland",selectIndex:4,scale:2.876397232,oldLatFixFactor:.45,latMin:-113,latMax:0,latGridMax:32.4437,lngMin:0,lngMax:140,lngGridMax:40.1306,gridHopZoom:6,defaultZoom:4,minZoom:2,maxZoom:7,tileUrl:conf.tilesUrl+"/rheinland/{z}/{x}/{y}.png"},arras:{fullName:"Arras",name:"arras",hash:"#arras",selectIndex:5,scale:.7191,oldLatFixFactor:1.3,latMin:-165,latMax:0,latGridMax:11.7973,lngMin:0,lngMax:165,lngGridMax:11.7973,gridHopZoom:5,defaultZoom:3,minZoom:3,maxZoom:5,tileUrl:conf.tilesUrl+"/arras/{z}/{x}/{y}.png"},prokhorovka:{fullName:"Prokhorovka",name:"prokhorovka",hash:"#prokhorovka",selectIndex:6,scale:.6491,oldLatFixFactor:1.3,latMin:-165,latMax:0,latGridMax:10.6484,lngMin:0,lngMax:165,lngGridMax:10.6484,gridHopZoom:5,defaultZoom:4,minZoom:3,maxZoom:6,tileUrl:conf.tilesUrl+"/prokhorovka/{z}/{x}/{y}.png"}};var defaults={flightName:"New Flight",flightSpeed:300,flightAltitude:1e3,flightColor:"red",pointType:"marker",pointColor:"red",pointName:"New Marker",circleColor:"red",polygonColor:"red"};var validatinatorConfig={"grid-jump-form":{"grid-input":"digitsLength:4"},"flight-leg-form":{"flight-leg-speed":"between:0,9999"},"connect-form":{"stream-password":"required","stream-code":"requiredIf:leader-checkbox:checked"}};return{maps:mapConfigs,default:defaults,validatinatorConfig:validatinatorConfig,titleText:'IL-2 Mission Planner <a href="https://github.com/ServError/il2missionplanner.com">Revived</a>',helpTooltip:"How to use this tool",clearTooltip:"Clear the map",exportTooltip:"Export mission plan",importTooltip:"Import mission plan",exportCSVTooltip:"Export Flight Plans to CSV file",gridHopTooltip:"Jump to grid",missionHopTooltip:"Jump to mission",settingsTooltip:"Settings",streamTooltip:conf.streaming===true?"Stream mission plan":"Streaming disabled on this server",flightModalTemplate:'<div id="flight-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-plane modal-icon\'></span> Configure Flight / Line</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <label for="flight-color">Color</label>\n            <select class="eleven columns" id="flight-color">\n                <option value="red">Red</option>\n                <option value="black">Black</option>\n                <option value="blue">Blue</option>\n            </select>\n        </div>\n        <div class="row">\n            <div class="three columns">\n                <label class="checkbox-label" for="flight-plan-checkbox">Flight Plan?</label>\n            </div>\n            <div class="eight columns">\n                <input id="flight-plan-checkbox" name="flight-plan-checkbox" type="checkbox" checked>\n            </div>\n        </div>\n        <fieldset>\n            <legend>Flight Plan Settings</legend>\n            <div class="row">\n                <label for="flight-name">Flight name</label>\n                <input id="flight-name" class="half-width" value="{name}" placeholder="name"></input>\n            </div>\n            <div class="row">\n                <label for="flight-speed">Average speed (kph/mph)</label>\n                <input id="flight-speed" class="half-width" value="{speed}"></input>\n            </div>\n            <div class="row">\n                <label for="flight-altitude">Average Altitude (m/ft)</label>\n                <input id="flight-altitude" class="half-width" value="{altitude}"></input>\n            </div>\n        </fieldset>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',flightTurnModalTemplate:'<div id="flight-turn-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-plane modal-icon\'></span> Flight Turn Point</h2>\n    </div>\n    <div id="flight-turn-error" class="row error-message hidden-section">\n    </div>\n    <form name="flight-turn-form" id="flight-turn-form" onsubmit="return false;">\n        <div class="row">\n            <label class="" for="flight-altitude">Altitude (m/ft)</label>\n            <input id="flight-turn-altitude" name="flight-turn-altitude" class="half-width" value="{altitude}"></input>\n        </div>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',flightLegModalTemplate:'<div id="flight-leg-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-plane modal-icon\'></span> Flight Leg</h2>\n    </div>\n    <div id="flight-leg-error" class="row error-message hidden-section">\n    </div>\n    <form name="flight-leg-form" id="flight-leg-form" onsubmit="return false;">\n        <div class="row">\n            <label class="" for="flight-speed">Speed (kph/mph)</label>\n            <input id="flight-leg-speed" name="flight-leg-speed" class="half-width" value="{speed}"></input>\n        </div>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',circleModalTemplate:'<div id="circle-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-circle modal-icon\'></span>Circle color</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <label for="circleColor">Color</label>\n            <select class="eleven columns" id="circleColor">\n                <option value="red">Red</option>\n                <option value="black">Black</option>\n                <option value="blue">Blue</option>\n            </select>\n        </div>\n        <div class="row">\n            <div class="five columns">\n                <label class="checkbox-label" for="circle-fill-checkbox">\n                    Fill circle?\n                </label>\n            </div>\n            <div class="seven columns">\n                <input id="circle-fill-checkbox" name="circle-fill-checkbox" type="checkbox" checked>\n            </div>\n        </div>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',polygonModalTemplate:'<div id="polygon-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-star-o modal-icon\'></span>Polygon color</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <label for="polygonColor">Color</label>\n            <select class="eleven columns" id="polygonColor">\n                <option value="red">Red</option>\n                <option value="black">Black</option>\n                <option value="blue">Blue</option>\n            </select>\n        </div>\n        <div class="row">\n            <div class="three columns">\n                <label class="checkbox-label" for="polygon-fill-checkbox">Fill polygon?</label>\n            </div>\n            <div class="eight columns">\n                <input id="polygon-fill-checkbox" name="polygon-fill-checkbox" type="checkbox" checked>\n            </div>\n        </div>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',confirmClearModalTemplate:'<div id="confirm-clear-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-trash modal-icon\'></span> Clear the map</h2>\n    </div>\n    <div class="row">\n        <p>\n            Are you sure? This action cannot be undone.\n        </p>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row buttom-row">\n            <button id="confirm-cancel-button" class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',helpModalTemplate:'<div id="help-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-question modal-icon\'></span> Help</h2>\n    </div>\n    <div class="row">\n        <h3 class="help-header" style="text-align:center">Map your flight plan</h3>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">flight mapping tool</span> <span class=\'fa fa-plane\'></span>\n            to plan your flight, one leg at a time. After naming your flight and giving it a default speed,\n            you can edit the speed of a particular leg by clicking on it\'s info.\n        </p>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">point mapping tool</span> <span class=\'fa fa-map-marker\'></span>\n            to mark a point of interest, such as a target, airfield or ground position. Hover over points\n            to view their notes.\n        </p>\n    </div>\n    <div class="row">\n        <p>\n            After placement, use the <span class="bold">edit button</span> <span class=\'fa fa-edit\'></span>\n            to move and change elements on the map. Use the <span class="bold">delete button</span>\n            <span class=\'fa fa-eraser\'></span> to remove specific elements, and clear the entire map\n            with the <span class="bold">clear button</span> <span class=\'fa fa-trash\'></span>.\n        </p>\n    </div>\n    <div class="row">\n        <h3 class="help-header" style="text-align:center">Navigate the map</h3>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">jump to grid tool</span> <span class=\'fa fa-th-large\'></span>\n            to jump to a specific, four digit grid number on the map.\n        </p>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">crop tool</span> <span class=\'fa fa-crop\'></span>\n            to fit the current flight plan in the window.\n        </p>\n    </div>\n    <div class="row">\n        <h3 class="help-header" style="text-align:center">Share mission plans</h3>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">export tool</span> <span class=\'fa fa-download\'></span>\n            to download a save file of the current mission plan.\n        </p>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">import tool</span> <span class=\'fa fa-upload\'></span>\n            to load a mission plan from a save file.\n        </p>\n    </div>\n    <div class="row">\n        <p>\n            Use the <span class="bold">stream tool</span> <span class=\'fa fa-share-alt\'></span>\n            to share missions in real time. Leaders can share their plans with viewers in a\n            password protected session.\n        </p>\n    </div>\n    <div class="row">\n        <h3 class="help-header" style="text-align:center">Configure the map</h3>\n    </div>\n    <div class="row">\n        <p>\n            Access the <span class="bold">settings</span> <span class=\'fa fa-gear\'></span>\n            to change the map and alter the style of the map text.\n        </p>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row buttom-row">\n            <button id="help-done-button" class="modal-ok button-primary" type="submit">Done</button>\n        </div>\n    </form>\n</div>\n',pointModalTemplate:'<div id="target-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-map-marker modal-icon\'></span> Point of Interest</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <label class="" for="target-name">Name</label>\n            <input id="target-name" class="half-width" value="{name}" placeholder="name"></input>\n        </div>\n        <div class="row">\n            <label for="point-type-select">Type</label>\n            <select class="u-full-width" id="point-type-select">\n                <option value="point">Point</option>\n                <option value="marker">Marker</option>\n                <option value="target">Target</option>\n                <option value="bomb-target">Bombing Target</option>\n                <option value="combat">Combat</option>\n                <option value="ground-combat">Ground Combat</option>\n                <option value="takeoff">Takeoff</option>\n                <option value="landing">Landing</option>\n                <option value="base">Base</option>\n                <option value="plane">Aircraft</option>\n                <option value="re-af">Airfield (Random Expert)</option>\n                <option value="re-art">Artillery (Random Expert)</option>\n                <option value="re-hq">Headquarters (Random Expert)</option>\n                <option value="re-motorcade">Motorcade (Random Expert)</option>\n                <option value="re-point-active">Active Point (Random Expert)</option>\n                <option value="re-point">Point (Random Expert)</option>\n                <option value="re-tanks">Tank (Random Expert)</option>\n                <option value="re-warehouse">Warehouse (Random Expert)</option>\n                <option value="re-fort">Fort (Random Expert)</option>\n                <option value="taw-af">Airfield (TAW)</option>\n                <option value="taw-arta">Artillery (TAW)</option>\n                <option value="taw-bridge">Bridge (TAW)</option>\n                <option value="taw-city">City (TAW)</option>\n                <option value="taw-def">Defences (TAW)</option>\n                <option value="taw-depo">Depot (TAW)</option>\n                <option value="taw-supply">Supply (TAW)</option>\n                <option value="taw-tank">Tank (TAW)</option>\n                <option value="taw-train">Train (TAW)</option>\n            </select>\n        </div>\n        <div class="row">\n            <p>Note: Point is for appending information to flight plans.</p>\n        </div>\n        <div class="row">\n            <label for="point-color-select">Color</label>\n            <select class="u-full-width" id="point-color-select">\n                <option value="black">Black</option>\n                <option value="red">Red</option>\n                <option value="blue">Blue</option>\n            </select>\n        </div>\n        <div class="row">\n            <p>Note: If a black icon is unavailable, it will default to blue.</p>\n        </div>\n        <div class="row">\n            <label class="" for="target-notes">Notes</label>\n            <textarea id="target-notes" class="u-full-width" value="{notes}">{notes}</textarea>\n        </div>\n        <div class="row">\n            <label class="" for="target-photo">Info Picture URL (Destination server must support HTTPS + CORS)</label>\n            <input type="url" id="target-photo" class="u-full-width" value="{photo}">{photo}</input>\n            <button class="modal-test-photo" type="button">Validate</button>\n            <div id="photo-status-hidden" class="row hidden-section">\n                <span id=\'checkmark\' class=\'fa fa-check modal-icon\'></span>\n            </div>\n        </div>\n        <div class="row button-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',importModalTemplate:'<div id="import-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-upload modal-icon\'></span> Import Mission</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <input id="import-file" type="file" name="importFile"></input>\n        </div>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Import</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',gridJumpModalTemplate:'<div id="gridhop-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-th-large modal-icon\'></span> Jump to Grid</h2>\n    </div>\n    <div id="grid-jump-error" class="row error-message hidden-section">\n    </div>\n    <form name="grid-jump-form" id="grid-jump-form" onsubmit="return false;">\n        <div class="modal-item row">\n            <label class="modal-item-label" for="grid-input">Grid</label>\n            <input id="grid-input" name="grid-input" class="modal-item-input" placeholder="0000" maxlength="4"></input>\n        </div>\n        <div class="row buttom-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel" type="button">Cancel</button>\n        </div>\n    </form>\n</div>\n',settingsModalTemplate:'<div id="settings-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-gear modal-icon\'></span> Settings</h2>\n    </div>\n    <form id="settings-form" onsubmit="return false;">\n        <fieldset>\n            <legend>Select Map</legend>\n            <div class="row">\n                <div class="one column"></div>\n                <select class="eleven columns" id="map-select">\n                    <option value="stalingrad">Stalingrad</option>\n                    <option value="moscow">Moscow</option>\n                    <option value="luki">Velikie Luki</option>\n                    <option value="kuban">Kuban</option>\n                    <option value="rheinland">Rheinland</option>\n                    <option value="arras">Arras</option>\n                    <option value="prokhorovka">Prokhorovka</option>\n                </select>\n            </div>\n        </fieldset>\n\n        <fieldset>\n            <legend>Units of Measurement</legend>\n            <div class="row">\n                <div class="one column"></div>\n                <select class="eleven columns" id="units-select">\n                    <option value="metric">Metric</option>\n                    <option value="imperial">Imperial</option>\n                </select>\n            </div>\n        </fieldset>\n\n        <fieldset>\n            <legend>Map Text</legend>\n            <div class="row">\n                <div class="one column"></div>\n                <div class="eleven columns">\n                    <label class="" for="selectStyle">Style (Changes will trigger a reload, save first)</label>\n                </div>\n                <select class="eleven columns" id="style-select">\n                    <option value="cb">CB</option>\n                    <option value="classic">Classic</option>\n                </select>\n            </div>\n            <fieldset>\n                <legend>Classic Style Settings</legend>\n                <div class="row">\n                    <div class="one column"></div>\n                    <div class="three columns">\n                        <label class="" for="invertText">Dark</label>\n                    </div>\n                    <div class="eight columns">\n                        <input id="invert-text-checkbox" type="checkbox" name="invertText">\n                    </div>\n                </div>\n                <div class="row">\n                    <div class="one column"></div>\n                    <div class="three columns">\n                        <label class="" for="showBackground">Background</label>\n                    </div>\n                    <div class="eight columns">\n                        <input id="text-background-checkbox" type="checkbox" name="showBackground" value="inverted">\n                    </div>\n                </div>\n            </fieldset>\n        </fieldset>\n        <div class="row button-row">\n            <button class="modal-ok button-primary" type="submit">Okay</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',streamModalTemplate:'<div id="stream-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-share-alt modal-icon\'></span> Mission Streaming</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <p>\n                Start streaming or connect to an existing one.\n            </p>\n        </div>\n        <div class="row buttom-row">\n            <button id="stream-start-button" class="modal-ok button-primary" type="submit">New Stream</button>\n            <button id="stream-connect-button" class="modal-ok button-primary" type="submit">Connect</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',startStreamModalTemplate:'<div id="stream-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-share-alt modal-icon\'></span> Start Streaming</h2>\n    </div>\n    <div id="start-stream-error" class="row error-message hidden-section">\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <div class="row">\n                <label for="stream-name">Stream name</label>\n                <input id="stream-name" class="half-width" placeholder="name" maxlength="32"></input>\n            </div>\n            <div class="row">\n                <label for="stream-password">Password</label>\n                <input id="stream-password" class="half-width" placeholder="password" maxlength="32"></input>\n            </div>\n            <div class="row">\n                <label for="stream-leader-code">Leader code</label>\n                <input id="stream-leader-code" class="half-width" placeholder="code" maxlength="32"></input>\n            </div>\n        </div>\n        <div class="row buttom-row">\n            <button id="stream-start-confirm-button" class="modal-ok button-primary" type="submit">Start Streaming</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',connectStreamModalTemplate:'<div id="connect-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-share-alt modal-icon\'></span> Start Streaming</h2>\n    </div>\n    <div id="connect-stream-error" class="row error-message hidden-section">\n    </div>\n    <form name="connect-form" onsubmit="return false;">\n        <fieldset>\n            <legend>Select Stream</legend>\n            <div class="row">\n                <div class="one column"></div>\n                <select id="stream-select" class="eleven columns" id="stream-select">\n                </select>\n            </div>\n        </fieldset>\n        <div class="row">\n            <label for="stream-password">Password</label>\n            <input id="stream-password" name="stream-password" class="half-width" placeholder="password"></input>\n        </div>\n        <div class="row">\n            <div class="five columns">\n                <label class="checkbox-label" for="leader-checkbox">\n                    Connect as flight leader?\n                </label>\n            </div>\n            <div class="seven columns">\n                <input id="leader-checkbox" name="leader-checkbox" type="checkbox">\n            </div>\n        </div>\n        <div id="leader-hidden" class="row hidden-section">\n            <label for="stream-code">Leader Code</label>\n            <input id="stream-code" name="stream-code" class="half-width" placeholder="code"></input>\n        </div>\n        <div class="row buttom-row">\n            <button id="stream-connect-button" class="modal-ok button-primary" type="submit">Connect</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',alreadyConnectedModalTemplate:'<div id="already-connected-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-share-alt modal-icon\'></span> Connected</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <p>\n                You are currently connected.\n            </p>\n        </div>\n        <div class="row">\n            <p>\n                <b>Stream Name: </b>{streamName}\n            </p>\n        </div>\n        <div class="row buttom-row">\n            <button id="disconnect-button" class="modal-ok button-primary" type="submit">Disconnect</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n',alreadyStreamingModalTemplate:'<div id="already-streaming-modal" class="container">\n    <div class="row">\n        <h2><span class=\'fa fa-share-alt modal-icon\'></span> Streaming</h2>\n    </div>\n    <form onsubmit="return false;">\n        <div class="row">\n            <p>\n                You are currently streaming your mission plan.\n            </p>\n        </div>\n        <div class="row">\n            <p>\n                <b>Stream Name: </b>{streamName}\n            </p>\n        </div>\n        <div class="row">\n            <div class="six columns">\n                <label class="checkbox-label" for="already-streaming-checkbox">\n                    Show password and leader code?\n                </label>\n            </div>\n            <div class="six columns">\n                <input id="already-streaming-checkbox" name="already-streaming-checkbox" type="checkbox">\n            </div>\n        </div>\n        <div id="already-streaming-hidden" class="row hidden-section">\n            <p>\n                <b>Password: </b>{streamPassword}<br>\n                <b>Leader Code: </b>{streamCode}\n            </p>\n        </div>\n        <div class="row buttom-row">\n            <button id="stop-streaming-button" class="modal-ok button-primary" type="submit">Stop Streaming</button>\n            <button class="modal-cancel">Cancel</button>\n        </div>\n    </form>\n</div>\n'}}()},{}],3:[function(require,module,exports){(function(){var content=require("./content.js");L.Control.TitleControl=L.Control.extend({options:{position:"topright"},onAdd:function(e){L.DomEvent.stop(e);var container=L.DomUtil.create("div","title-control");L.DomEvent.disableClickPropagation(container);container.innerHTML=content.titleText;return container}});L.Control.CustomToolbar=L.Control.extend({options:{position:"bottomleft"},initialize:function(options){L.Control.prototype.initialize.call(this,options)},onAdd:function(e){L.DomEvent.stop(e);var container=L.DomUtil.create("div","leaflet-bar");L.DomEvent.disableClickPropagation(container);for(var i=0;i<this.options.buttons.length;i++){var link=L.DomUtil.create("a","fa "+this.options.buttons[i].icon,container);link.title=this.options.buttons[i].tooltip;link.id=this.options.buttons[i].id;link.addEventListener("click",this.options.buttons[i].clickFn)}return container}})})()},{"./content.js":2}],4:[function(require,module,exports){module.exports=function(leaflet){const URL_PREFIX="img/",URL_SUFFIX=".png",URL_DELIM="-";function buildIconUrl(type,color){return URL_PREFIX+color+URL_DELIM+type+URL_SUFFIX}return{factory:function(type,color){if(color==="black"&&(this._isRandomExpertIcon(type)||this._isTawIcon(type))){color="blue"}var iconOpts={iconSize:type==="re-point-active"?[40,60]:[32,32],iconUrl:buildIconUrl(type,color)};return leaflet.icon(iconOpts)},textIconFactory:function(text,classes){return leaflet.divIcon({className:classes,html:text,iconSize:[165,0]})},_isRandomExpertIcon:function(type){return type.substring(0,2)==="re"},_isTawIcon:function(type){return type.substring(0,3)==="taw"&&type!=="taw-af"}}}},{}],5:[function(require,module,exports){(function(){"use strict";var content=require("./content.js");var calc=require("./calc.js");var util=require("./util.js");var icons=require("./icons.js")(L);var webdis=require("./webdis.js");require("./controls.js");var conf=JSON.parse('{\n  "apiUrl"    : "NONE",\n  "serverUrl" : "https://www.example.com",\n  "tilesUrl"  : "https://www.example.com/tiles",\n  "streaming" : false,\n  "webdisUrl" : "https://www.example.com/WEBDIS"\n}');const EXPORT_REV=2,RED="#9A070B",RED_FRONT="#BD0101",BLUE="#3C6490",BLUE_FRONT="#4D4B40",BLACK="#000000",FLIGHT_OPACITY=.8,CIRCLE_OPTIONS={color:RED,weight:2,opacity:FLIGHT_OPACITY},LINE_OPTIONS={color:RED,weight:2,opacity:FLIGHT_OPACITY};var map,mapTiles,mapConfig,drawnItems,drawnMarkers,hiddenLayers,frontline,drawControl,selectedMapIndex;var state={units:window.localStorage.getItem("units")||"metric",style:window.localStorage.getItem("style")||"cb",colorsInverted:false,showBackground:true,streaming:false,connected:false,changing:false,streamInfo:{},streamingAvailable:conf.streaming===true?webdis.init():false};L.PolylineDecorator.include(L.Evented);L.CRS.SimpleFinite=L.Util.extend({},L.CRS.Simple,{infinite:false});L.CRS.SimpleFlip=L.Util.extend({},L.CRS.Simple,{transformation:new L.Transformation(1,0,1,0)});var V=new Validatinator(content.validatinatorConfig);function mapIsEmpty(){return drawnItems.getLayers().length===0&&frontline.getLayers().length===0}function applyCircle(circle){if(state.changing||state.connected){return}if(typeof circle.color==="undefined"){circle.options.color=content.default.circleColor}var clickedOk=false;map.openModal({color:circle.options.color,fillOpacity:circle.options.fillOpacity,template:content.circleModalTemplate,zIndex:1e4,onShow:function(e){var element=document.getElementById("circleColor");element.focus();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){clickedOk=true;e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})},onHide:function(e){if(clickedOk){circle.options.color=document.getElementById("circleColor").value;var circleFillCheckbox=document.getElementById("circle-fill-checkbox");switch(circle.options.color){case"blue":circle.options.color=BLUE;break;case"black":circle.options.color=BLACK;break;case"red":default:circle.options.color=RED;break}circle.setStyle({color:circle.options.color});if(!circleFillCheckbox.checked){circle.options.fillOpacity=0}else{circle.options.fillOpacity=.2}circle.setStyle({fillOpacity:circle.options.fillOpacity})}else{drawnItems.removeLayer(circle)}checkButtonsDisabled()}})}function applyPolygon(polygon){if(state.changing||state.connected){return}if(typeof polygon.color==="undefined"){polygon.options.color=content.default.polygonColor}polygon.options.isPolygon=true;var clickedOk=false;map.openModal({color:polygon.options.color,fillOpacity:polygon.options.fillOpacity,template:content.polygonModalTemplate,zIndex:1e4,onShow:function(e){var element=document.getElementById("polygonColor");element.focus();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){clickedOk=true;e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})},onHide:function(e){if(clickedOk){polygon.options.color=document.getElementById("polygonColor").value;var polygonFillCheckbox=document.getElementById("polygon-fill-checkbox");switch(polygon.options.color){case"blue":polygon.options.color=BLUE;break;case"black":polygon.options.color=BLACK;break;case"red":default:polygon.options.color=RED;break}polygon.setStyle({color:polygon.options.color});if(!polygonFillCheckbox.checked){polygon.options.fillOpacity=0}else{polygon.options.fillOpacity=.2}polygon.setStyle({fillOpacity:polygon.options.fillOpacity})}else{drawnItems.removeLayer(polygon)}checkButtonsDisabled()}})}function newFlightDecorator(route){return L.polylineDecorator(route,{patterns:[{offset:6,repeat:300,symbol:L.Symbol.arrowHead({pathOptions:{opacity:0,fillOpacity:FLIGHT_OPACITY,color:route.color}})}]})}function applyCustomFlightTurn(marker){if(state.changing||state.connected){return}var parentRoute=drawnItems.getLayer(marker.parentId);map.openModal({altitude:marker.options.altitude,template:content.flightTurnModalTemplate,zIndex:1e4,onShow:function(e){var element=document.getElementById("flight-turn-altitude");element.focus();element.select();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){if(V.passes("flight-turn-form")){var newAltitude=parseInt(element.value);parentRoute.altitudes[marker.index]=newAltitude;marker.options.altitude=newAltitude;if(marker.priorMarkerId!==0){var altDiff=calc.altitudeUnitAdjust(Math.abs(parentRoute.altitudes[marker.index]-parentRoute.altitudes[marker.index-1]),state.units);var priorMarker=drawnMarkers.getLayer(marker.priorMarkerId);priorMarker.options.altDiff=altDiff;applyCustomFlightLegCallback(priorMarker)}if(marker.followingMarkerId!==0){altDiff=calc.altitudeUnitAdjust(Math.abs(parentRoute.altitudes[marker.index]-parentRoute.altitudes[marker.index+1]),state.units);var followingMarker=drawnMarkers.getLayer(marker.followingMarkerId);followingMarker.options.altDiff=altDiff;applyCustomFlightLegCallback(followingMarker)}applyCustomFlightTurnCallback(marker);e.modal.hide()}else{var errorElement=document.getElementById("flight-turn-error");var units=state.units==="metric"?"meters":"feet";errorElement.innerHTML="Please input a valid altitude in"+units+".";util.removeClass(errorElement,"hidden-section");errorElement.focus()}});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}function applyCustomFlightTurnCallback(marker){var newContent=util.formatFlightTurnMarker(marker.options.altitude,state.units);if(marker.priorMarkerId!==0){marker.setIcon(icons.textIconFactory(newContent,"flight-turn "+getMapTextClasses(state)))}else{marker.setIcon(icons.textIconFactory(newContent,"flight-start-alt "+getMapTextClasses(state)))}publishMapState()}function applyCustomFlightLeg(marker){if(state.changing||state.connected){return}var parentRoute=drawnItems.getLayer(marker.parentId);map.openModal({speed:parentRoute.speeds[marker.index],template:content.flightLegModalTemplate,zIndex:1e4,onShow:function(e){var element=document.getElementById("flight-leg-speed");element.focus();element.select();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){if(V.passes("flight-leg-form")){var newSpeed=parseInt(element.value);parentRoute.speeds[marker.index]=newSpeed;marker.options.speed=newSpeed;applyCustomFlightLegCallback(marker);e.modal.hide()}else{var errorElement=document.getElementById("flight-leg-error");var units=state.units==="metric"?"kilometers":"miles";errorElement.innerHTML="Please input a valid speed in"+units+"per hour.";util.removeClass(errorElement,"hidden-section");errorElement.focus()}});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}function applyCustomFlightLegCallback(marker){marker.options.time=util.formatTime(calc.time(marker.options.speed,parseFloat(marker.options.gndDistance)+parseFloat(marker.options.altDiff)));var newContent=util.formatFlightLegMarker(marker.options.gndDistance,marker.options.heading,marker.options.speed,marker.options.time,state.units);marker.setIcon(icons.textIconFactory(newContent,"flight-leg  nobg "+getMapTextClasses(state)));publishMapState()}function applyFlightPlanCallback(route,newFlight){const routeClickHandlerFactory=function(clickedRoute){return function(){if(state.changing||state.connected){return}deleteAssociatedLayers(L.layerGroup([clickedRoute]));applyFlightPlan(clickedRoute)}};const markerClickHandlerFactory=function(clickedMarker){return function(){if(state.changing||state.connected){return}applyCustomFlightLeg(clickedMarker)}};const turnClickHandlerFactory=function(clickedMarker){return function(){if(state.changing||state.connected){return}applyCustomFlightTurn(clickedMarker)}};if(newFlight){route.on("click",routeClickHandlerFactory(route))}var id=route._leaflet_id;var coords=route.getLatLngs();var decorator=newFlightDecorator(route);decorator.parentId=id;decorator.addTo(drawnMarkers);decorator.on("click",routeClickHandlerFactory(route));if(typeof route.speeds==="undefined"||route.speedDirty||route.wasEdited){route.speeds=util.defaultPopulateArray(route.speed,coords.length-1);route.speedDirty=false}if(typeof route.altitudes==="undefined"||route.altitudeDirty||route.wasEdited){route.altitudes=util.defaultPopulateArray(route.altitude,coords.length);route.altitudeDirty=false}var turnCoords=L.latLng(coords[0].lat,coords[0].lng);var turnMarkerContent=util.formatFlightTurnMarker(route.altitudes[0],state.units);var turnMarker=L.marker(turnCoords,{altitude:route.altitudes[0],draggable:false,icon:icons.textIconFactory(turnMarkerContent," flight-start-alt "+getMapTextClasses(state))});turnMarker.parentId=id;turnMarker.priorMarkerId=0;turnMarker.index=0;turnMarker.on("click",turnClickHandlerFactory(turnMarker));turnMarker.addTo(drawnMarkers);var orientation=0;var heading=calc.heading(coords[0],coords[1]);if(heading>180){orientation="flip"}route.setText(route.name,{offset:-10,orientation:orientation,attributes:{class:"text-path-flight-title",fill:route.color}});for(var i=0;i<coords.length-1;i++){var altDiff=calc.altitudeUnitAdjust(Math.abs(route.altitudes[i]-route.altitudes[i+1]),state.units);var gndDistance=mapConfig.scale*L.CRS.Simple.distance(coords[i],coords[i+1]);var airDistance=parseFloat(altDiff)+parseFloat(gndDistance);var heading=calc.heading(coords[i],coords[i+1]);var midpoint=calc.midpoint(coords[i],coords[i+1]);var time=util.formatTime(calc.time(route.speeds[i],airDistance));var markerContent=util.formatFlightLegMarker(gndDistance,heading,route.speeds[i],time,state.units);var marker=L.marker(midpoint,{altDiff:altDiff,gndDistance:gndDistance,heading:heading,time:time,speed:route.speeds[i],icon:icons.textIconFactory(markerContent,"flight-leg nobg "+getMapTextClasses(state))});marker.parentId=id;marker.index=i;marker.on("click",markerClickHandlerFactory(marker));marker.addTo(drawnMarkers);turnMarker.followingMarkerId=marker._leaflet_id;turnCoords=L.latLng(coords[i+1].lat,coords[i+1].lng);turnMarkerContent=util.formatFlightTurnMarker(route.altitudes[i+1],state.units);turnMarker=L.marker(turnCoords,{altitude:route.altitudes[i],draggable:false,icon:icons.textIconFactory(turnMarkerContent," flight-turn "+getMapTextClasses(state))});turnMarker.parentId=id;turnMarker.priorMarkerId=marker._leaflet_id;if(i===coords.length-2){turnMarker.followingMarkerId=0}turnMarker.index=i+1;turnMarker.on("click",turnClickHandlerFactory(turnMarker));turnMarker.addTo(drawnMarkers)}for(var i=0;i<coords.length-1;i++){var routeMarker=L.circleMarker(coords[i],{interactive:true,radius:1,color:route.color,fillColor:route.color,opacity:FLIGHT_OPACITY,fillOpacity:FLIGHT_OPACITY});routeMarker.parentId=id;routeMarker.index=i;routeMarker.addTo(drawnMarkers)}var endMarker=L.circleMarker(coords[coords.length-1],{interactive:false,radius:3,color:route.color,fillColor:route.color,opacity:FLIGHT_OPACITY,fillOpacity:FLIGHT_OPACITY});endMarker.parentId=id;endMarker.addTo(drawnMarkers);publishMapState()}function applyFlightPlan(route){if(state.changing||state.connected){return}var newFlight=false;if(typeof route.altitude==="undefined"){route.altitude=content.default.flightAltitude;newFlight=true}if(typeof route.speed==="undefined"){route.speed=content.default.flightSpeed;newFlight=true}if(typeof route.name==="undefined"){route.name=content.default.flightName}if(typeof route.color==="undefined"){route.color=content.default.flightColor}var initialSpeed=route.speed;var averageAltitude=0;if(!newFlight){for(var i=0;i<route.altitudes.length;i++){averageAltitude=averageAltitude+route.altitudes[i]}averageAltitude=averageAltitude/route.altitudes.length}else{averageAltitude=route.altitude}var clickedOk=false;map.openModal({altitude:averageAltitude,speed:route.speed,name:route.name,color:route.color,isFlightPlan:route.isFlightPlan,template:content.flightModalTemplate,zIndex:1e4,onShow:function(e){var element=document.getElementById("flight-name");element.focus();element.select();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){clickedOk=true;e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})},onHide:function(e){if(clickedOk){var flightPlanCheckbox=document.getElementById("flight-plan-checkbox");route.isFlightPlan=flightPlanCheckbox.checked;route.name=document.getElementById("flight-name").value;route.speed=parseInt(document.getElementById("flight-speed").value);route.speedDirty=route.speed!==initialSpeed;route.color=document.getElementById("flight-color").value;route.altitude=document.getElementById("flight-altitude").value;route.altitudeDirty=parseInt(route.altitude)!==parseInt(averageAltitude);switch(route.color){case"blue":route.color=BLUE;break;case"black":route.color=BLACK;break;case"red":default:route.color=RED;break}route.setStyle({color:route.color});if(route.isFlightPlan){applyFlightPlanCallback(route,newFlight)}else{route.interactive=false}}else if(newFlight){drawnItems.removeLayer(route)}else if(route.isFlightPlan){applyFlightPlanCallback(route,newFlight)}checkButtonsDisabled()}})}function applyTargetInfoCallback(target,newTarget){function targetClickHandlerFactory(clickedTarget){return function(){if(state.changing||state.connected){return}deleteAssociatedLayers(L.layerGroup([clickedTarget]));applyTargetInfo(clickedTarget)}}var id=target._leaflet_id;var coords=target.getLatLng();target.setIcon(icons.factory(target.type,target.color));if(newTarget){target.on("contextmenu",targetClickHandlerFactory(target))}var nameCoords=L.latLng(coords.lat,coords.lng);if(state.style==="classic"){var nameMarker=L.marker(nameCoords,{draggable:false,icon:icons.textIconFactory(target.name,"map-title target-title-classic "+getMapTextClasses(state))})}else{var markerColor=BLACK;if(target.color==="red"){markerColor=RED}else if(target.color==="blue"){markerColor=BLUE}if(target.type==="taw-af"||target.type==="re-af"){var nameMarker=L.marker(nameCoords,{draggable:false,icon:icons.textIconFactory("<font color="+markerColor+">"+target.name+"</font>","target-title-airfield")})}else if(target.type==="point"){var nameMarker=L.marker(nameCoords,{draggable:false,icon:icons.textIconFactory(target.name,"target-title-classic-centered map-text flight-leg")})}else{var nameMarker=L.marker(nameCoords,{draggable:false,icon:icons.textIconFactory("<font color="+markerColor+">"+target.name+"</font>","target-title-cb nobg")})}}if(util.validUrl(target.photo)){util.bindPicture(target.photo,target)}nameMarker.parentId=id;nameMarker.on("click",targetClickHandlerFactory(target));nameMarker.addTo(drawnMarkers);if(target.notes!==""){target.bindTooltip(target.notes,{direction:"left"}).addTo(drawnMarkers)}publishMapState()}function applyTargetInfo(target){if(state.changing||state.connected){return}var newTarget=false;if(typeof target.name==="undefined"){target.name=content.default.pointName;var newTarget=true}if(typeof target.notes==="undefined"){target.notes=""}if(typeof target.type==="undefined"){target.type=content.default.pointType}if(typeof target.color==="undefined"){target.color=content.default.pointColor}if(typeof target.photo==="undefined"){target.photo=""}var validPhoto=false;var clickedOk=false;map.openModal({name:target.name,notes:target.notes,photo:"",template:content.pointModalTemplate,zIndex:1e4,onShow:function(e){var element=document.getElementById("target-name");element.focus();element.select();var typeSelect=document.getElementById("point-type-select");typeSelect.value=target.type;var colorSelect=document.getElementById("point-color-select");colorSelect.value=target.color;var photoSelect=document.getElementById("target-photo");photoSelect.value=target.photo;L.DomEvent.on(e.modal._container.querySelector(".modal-test-photo"),"click",function(){if(util.validUrl(photoSelect.value)){var xhr=util.buildGetBlobXhr(photoSelect.value,function(){if(xhr.status===200){if(xhr.response!==""){target.photo=photoSelect.value;validPhoto=true;util.removeClass(document.getElementById("photo-status-hidden"),"hidden-section")}else{photoSelect.value="failed, try again";validPhoto=false;util.addClass(document.getElementById("photo-status-hidden"),"hidden-section")}}else{photoSelect.value="failed, try again";validPhoto=false;util.addClass(document.getElementById("photo-status-hidden"),"hidden-section")}})}else{photoSelect.value="failed, try again";validPhoto=false;util.addClass(document.getElementById("photo-status-hidden"),"hidden-section")}});L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){clickedOk=true;e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})},onHide:function(e){if(clickedOk){target.name=document.getElementById("target-name").value;target.notes=document.getElementById("target-notes").value;target.type=document.getElementById("point-type-select").value;target.color=document.getElementById("point-color-select").value;if(validPhoto){target.photo=document.getElementById("target-photo").value}applyTargetInfoCallback(target,newTarget)}else if(newTarget){drawnItems.removeLayer(target)}else{applyTargetInfoCallback(target,newTarget)}checkButtonsDisabled()}})}function deleteAssociatedLayers(parentLayers){var toDelete=[];parentLayers.eachLayer(function(layer){toDelete.push(layer._leaflet_id)});map.eachLayer(function(layer){if(toDelete.indexOf(layer.parentId)!==-1){map.removeLayer(layer)}});hiddenLayers.eachLayer(function(layer){if(toDelete.indexOf(layer.parentId)!==-1){hiddenLayers.removeLayer(layer)}});drawnMarkers.eachLayer(function(layer){if(toDelete.indexOf(layer.parentId)!==-1){drawnMarkers.removeLayer(layer)}})}function transferChildLayers(from,to){from.eachLayer(function(layer){if(typeof layer.parentId!=="undefined"){from.removeLayer(layer);to.addLayer(layer)}})}function showChildLayers(){transferChildLayers(hiddenLayers,map)}function hideChildLayers(){transferChildLayers(map,hiddenLayers)}function changeUnits(units){state.units=units;window.localStorage.setItem("units",units);var parentChanged=false;map.eachLayer(function(layer){if(layer.options&&typeof layer.options.speed!=="undefined"){if(!parentChanged){var parentRoute=drawnItems.getLayer(layer.parentId);parentRoute.speeds=parentRoute.speeds.map(speed=>calc.convertSpeed(speed,units));parentRoute.altitudes=parentRoute.altitudes.map(altitude=>calc.convertAltitude(altitude,units));parentChanged=true}layer.options.altDiff=calc.convertDistance(layer.options.altDiff,units);layer.options.speed=calc.convertSpeed(layer.options.speed,units);layer.options.gndDistance=parseFloat(calc.convertDistance(layer.options.gndDistance,units)).toFixed(1);applyCustomFlightLegCallback(layer)}});map.eachLayer(function(layer){if(layer.options&&typeof layer.options.altitude!=="undefined"){if(!parentChanged){var parentRoute=drawnItems.getLayer(layer.parentId);parentRoute.speeds=parentRoute.speeds.map(speed=>calc.convertSpeed(speed,units));parentRoute.altitudes=parentRoute.altitudes.map(altitude=>calc.convertAltitude(altitude,units));parentChanged=true}layer.options.altitude=calc.convertAltitude(layer.options.altitude,units);applyCustomFlightTurnCallback(layer)}})}function changeStyle(style){state.style=style;window.localStorage.setItem("style",style);window.location.reload()}function disableButtons(buttonList){for(var i=0;i<buttonList.length;i++){var element=document.getElementById(buttonList[i]);element.classList.add("leaflet-disabled")}}function enableButtons(buttonList){for(var i=0;i<buttonList.length;i++){var element=document.getElementById(buttonList[i]);element.classList.remove("leaflet-disabled")}}function checkButtonsDisabled(){var buttons=["export-button","missionhop-button"];if(!state.connected){buttons.push("clear-button")}if(mapIsEmpty()){disableButtons(buttons)}else{enableButtons(buttons)}buttons=["stream-button"];if(conf.streaming!==true){disableButtons(buttons)}buttons=["export-excel-button"];if(!util.flightPlanPresent(drawnItems)){disableButtons(buttons)}else{enableButtons(buttons)}}function clearMap(){drawnItems.clearLayers();drawnMarkers.clearLayers();frontline.clearLayers();hideChildLayers();hiddenLayers.clearLayers();publishMapState()}function exportMapToCSV(){var csvData=[];var FlightName="Flight Name";var FlightLeg="Flight Leg";var FlightHeading="Heading";var FlightLegDistance=state.units==="imperial"?"Distance (mi)":"Distance (km)";var FlightLegSpeed=state.units==="imperial"?"Speed (mph)":"Speed (kph)";var FlightLegAltitude=state.units==="imperial"?"Altitude (ft)":"Altitude (m)";csvData.push({FlightName:FlightName,FlightLeg:FlightLeg,FlightHeading:FlightHeading,FlightLegDistance:FlightLegDistance,FlightLegSpeed:FlightLegSpeed,FlightLegAltitude:FlightLegAltitude});drawnItems.eachLayer(function(layer){if(layer instanceof L.Polyline&&!(layer instanceof L.Polygon)){if(layer.isFlightPlan){var coords=layer.getLatLngs();for(var i=0;i<coords.length-1;i++){var FlightName=layer.name;var FlightLeg=i+1;var FlightHeading=Math.round(calc.heading(coords[i],coords[i+1]));var FlightLegDistance=parseFloat(mapConfig.scale*L.CRS.Simple.distance(coords[i],coords[i+1])).toFixed(1);var FlightLegSpeed=Math.round(layer.speeds[i]);var FlightLegAltitude=Math.round(layer.altitudes[i]);csvData.push({FlightName:FlightName,FlightLeg:FlightLeg,FlightHeading:FlightHeading,FlightLegDistance:FlightLegDistance,FlightLegSpeed:FlightLegSpeed,FlightLegAltitude:FlightLegAltitude})}}}});return csvData}function exportMapState(){var saveData={revision:EXPORT_REV,mapHash:window.location.hash,units:state.units,routes:[],points:[],circles:[],polygons:[]};drawnItems.eachLayer(function(layer){var saveLayer={};if(layer instanceof L.Polygon){saveLayer.latLngs=layer.getLatLngs();saveLayer.color=layer.options.color;saveLayer.fillOpacity=layer.options.fillOpacity;saveData.polygons.push(saveLayer)}else if(layer instanceof L.Polyline){saveLayer.latLngs=layer.getLatLngs();saveLayer.name=layer.name;saveLayer.speed=layer.speed;saveLayer.speeds=layer.speeds;saveLayer.altitude=layer.altitude;saveLayer.altitudes=layer.altitudes;saveLayer.color=layer.color;saveLayer.isFlightPlan=layer.isFlightPlan;saveData.routes.push(saveLayer)}else if(layer instanceof L.Circle){saveLayer.latLng=layer.getLatLng();saveLayer.radius=layer.getRadius();saveLayer.color=layer.options.color;saveLayer.fillOpacity=layer.options.fillOpacity;saveData.circles.push(saveLayer)}else if(layer instanceof L.Marker){saveLayer.latLng=layer.getLatLng();saveLayer.name=layer.name;saveLayer.type=layer.type;saveLayer.color=layer.color;saveLayer.notes=layer.notes;saveLayer.photo=layer.photo;saveData.points.push(saveLayer)}});return saveData}function selectMap(selectedMapConfig){var newIndex=selectedMapConfig.selectIndex;if(newIndex!==selectedMapIndex){selectedMapIndex=selectedMapConfig.selectIndex;window.location.hash=selectedMapConfig.hash;deleteAssociatedLayers(drawnItems);drawnItems.clearLayers();drawnMarkers.clearLayers();hiddenLayers.clearLayers();frontline.clearLayers();map.removeLayer(mapTiles);mapTiles=L.tileLayer(selectedMapConfig.tileUrl,{minZoom:selectedMapConfig.minZoom,maxZoom:selectedMapConfig.maxZoom,bounds:calc.tileBounds(selectedMapConfig)}).addTo(map);map.setMaxBounds(calc.maxBounds(selectedMapConfig));map.setView(calc.center(selectedMapConfig),selectedMapConfig.defaultZoom)}}function fitViewToMission(){map.flyToBounds(drawnItems.getBounds())}function getMapTextClasses(state){var classes="map-text";if(state.colorsInverted&&state.style==="classic"){classes+=" inverted"}if(!state.showBackground&&state.style==="classic"){classes+=" nobg"}return classes}function importMapState(saveData){clearMap();var revision=saveData.revision;var importedMapConfig=util.getSelectedMapConfig(saveData.mapHash,content.maps);selectMap(importedMapConfig);mapConfig=importedMapConfig;selectedMapIndex=mapConfig.selectIndex;state.units=saveData.units||"imperial";if(saveData.routes){for(var i=0;i<saveData.routes.length;i++){var route=saveData.routes[i];if(route.color!==BLUE&&route.color!==BLACK&&route.color!==RED){route.color=RED}var options={color:route.color,weight:2,opacity:FLIGHT_OPACITY};var newRoute=L.polyline(util.fixOldLatLngs(route.latLngs,mapConfig,revision),options);newRoute.name=route.name;newRoute.speed=route.speed;newRoute.speeds=route.speeds;newRoute.altitude=route.altitude;newRoute.altitudes=route.altitudes;newRoute.color=route.color;newRoute.isFlightPlan=route.isFlightPlan;drawnItems.addLayer(newRoute);if(newRoute.isFlightPlan){applyFlightPlanCallback(newRoute)}}}if(saveData.points){for(var i=0;i<saveData.points.length;i++){var point=saveData.points[i];var newPoint=L.marker(util.fixOldLatLng(point.latLng,mapConfig,revision),{icon:icons.factory(point.type,point.color)});newPoint.name=point.name;newPoint.type=point.type;newPoint.color=point.color;newPoint.notes=point.notes;newPoint.photo=point.photo;drawnItems.addLayer(newPoint);applyTargetInfoCallback(newPoint)}}if(saveData.circles){for(var i=0;i<saveData.circles.length;i++){var circle=saveData.circles[i];var newCircle=L.circle(util.fixOldLatLng(circle.latLng,mapConfig,revision),circle.radius);newCircle.options.color=circle.color;newCircle.options.fillOpacity=circle.fillOpacity;newCircle.options.opacity=FLIGHT_OPACITY;newCircle.options.weight=2;drawnItems.addLayer(newCircle)}}if(saveData.polygons){for(var i=0;i<saveData.polygons.length;i++){var polygon=saveData.polygons[i];var options={color:polygon.color,weight:2,opacity:FLIGHT_OPACITY,fillOpacity:polygon.fillOpacity};var newPolygon=L.polygon(util.fixOldLatLngs(polygon.latLngs,mapConfig,revision),options);newPolygon.options.isPolygon=true;newPolygon.options.color=polygon.color;newPolygon.options.fillOpacity=polygon.fillOpacity;drawnItems.addLayer(newPolygon)}}if(saveData.frontline){for(var frontNdx=0;frontNdx<saveData.frontline.length;frontNdx++){var blueFront=util.fixOldLatLngs(saveData.frontline[frontNdx][0],mapConfig,revision);var redFront=util.fixOldLatLngs(saveData.frontline[frontNdx][1],mapConfig,revision);L.polyline(blueFront,{color:BLUE_FRONT,opacity:1}).addTo(frontline);L.polyline(redFront,{color:RED_FRONT,opacity:1}).addTo(frontline)}}}function publishMapState(){if(state.streaming){var saveData=exportMapState();webdis.publish(state.streamInfo.name,state.streamInfo.password,state.streamInfo.code,window.escape(JSON.stringify(saveData)))}}function startConnectedMode(){map.removeControl(drawControl);map.removeControl(clearButton)}function endConnectedMode(){map.removeControl(gridToolbar);map.removeControl(importExportToolbar);map.addControl(drawControl);map.addControl(gridToolbar);map.addControl(clearButton);map.addControl(importExportToolbar);checkButtonsDisabled()}function setupCheckboxTogglableElement(checkboxId,elementId){var checkbox=document.getElementById(checkboxId);var element=document.getElementById(elementId);L.DomEvent.on(checkbox,"click",function(){if(checkbox.checked){util.removeClass(element,"hidden-section")}else{util.addClass(element,"hidden-section")}})}if(window.location.hash!==""&&!util.isAvailableMapHash(window.location.hash,content.maps)){var responseBody=null;var url;if(conf.apiUrl==="NONE"){var cors_api_host="cors-anywhere.herokuapp.com";var cors_api_url="https://"+cors_api_host+"/";if(window.location.hash.substring(0,10)==="#json-url="&&window.location.hash.length>10){url=window.location.hash.slice(10)}else{switch(window.location.hash){case"#combatbox":url="";break;case"#virtualpilots":url="";break;default:url="";window.location.hash=""}}}else{url=conf.apiUrl+"/servers/"+window.location.hash.substr(1)}if(url!==""){var xhr=util.buildGetXhr(url,function(){if(xhr.readyState===4){if(xhr.response!==""){responseBody=JSON.parse(xhr.responseText);importMapState(responseBody);fitViewToMission();checkButtonsDisabled()}else{window.location.hash=""}}else{window.location.hash=""}})}}mapConfig=util.getSelectedMapConfig(window.location.hash,content.maps);selectedMapIndex=mapConfig.selectIndex;map=L.map("map",{crs:L.CRS.Simple,attributionControl:false});mapTiles=L.tileLayer(mapConfig.tileUrl,{minZoom:mapConfig.minZoom,maxZoom:mapConfig.maxZoom,bounds:calc.tileBounds(mapConfig)}).addTo(map);map.setView(calc.center(mapConfig),mapConfig.defaultZoom);map.setMaxBounds(calc.maxBounds(mapConfig));drawnItems=L.featureGroup();map.addLayer(drawnItems);drawnMarkers=L.featureGroup();map.addLayer(drawnMarkers);frontline=L.featureGroup();map.addLayer(frontline);hiddenLayers=L.featureGroup();drawControl=new L.Control.Draw({draw:{polygon:{showLength:false,shapeOptions:LINE_OPTIONS},rectangle:false,circle:{showRadius:false,shapeOptions:CIRCLE_OPTIONS},polyline:{showLength:false,shapeOptions:LINE_OPTIONS},marker:{icon:icons.factory(content.default.pointType,content.default.pointColor)},circlemarker:false},edit:{featureGroup:drawnItems,edit:{selectedPathOptions:{maintainColor:true,opacity:.4,fill:false}}}});L.drawLocal.draw.toolbar.buttons.polyline="Map a flight / Draw a polyline";L.drawLocal.draw.handlers.polyline.tooltip.start="Click to start a flight plan / polyline";L.drawLocal.draw.handlers.polyline.tooltip.cont="Click to continue the flight plan / polyline";L.drawLocal.draw.handlers.polyline.tooltip.end="Click last point to finish flight plan / polyline";map.addControl(drawControl);var titleControl=new L.Control.TitleControl({});map.addControl(titleControl);var clearButton=new L.Control.CustomToolbar({position:"bottomleft",buttons:[{id:"clear-button",icon:"fa-trash",tooltip:content.clearTooltip,clickFn:function(){if(!mapIsEmpty()){map.openModal({template:content.confirmClearModalTemplate,onShow:function(e){var element=document.getElementById("confirm-cancel-button");element.focus();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){clearMap();e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})},onHide:function(){checkButtonsDisabled()}})}}}]});map.addControl(clearButton);var helpSettingsToolbar=new L.Control.CustomToolbar({position:"bottomright",buttons:[{id:"settings-button",icon:"fa-gear",tooltip:content.settingsTooltip,clickFn:function(){map.openModal({template:content.settingsModalTemplate,onShow:function(e){var mapSelect=document.getElementById("map-select");mapSelect.selectedIndex=selectedMapIndex;var originalIndex=selectedMapIndex;var styleSelect=document.getElementById("style-select");var originalStyleValue=state.style;styleSelect.value=originalStyleValue;var invertCheckbox=document.getElementById("invert-text-checkbox");invertCheckbox.checked=state.colorsInverted;var unitsSelect=document.getElementById("units-select");var originalUnitValue=state.units;unitsSelect.value=originalUnitValue;var backgroundCheckbox=document.getElementById("text-background-checkbox");backgroundCheckbox.checked=state.showBackground;mapSelect.focus();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){if(mapSelect.selectedIndex!==originalIndex){var selectedMap=mapSelect.options[mapSelect.selectedIndex].value;mapConfig=content.maps[selectedMap];selectMap(mapConfig);selectedMapIndex=mapSelect.selectedIndex;publishMapState()}if(styleSelect.value!==originalStyleValue){changeStyle(styleSelect.value)}if(unitsSelect.value!==originalUnitValue){changeUnits(unitsSelect.value)}if(state.style==="classic"){if(invertCheckbox.checked!==state.colorsInverted){state.colorsInverted=invertCheckbox.checked;var textElements=document.getElementsByClassName("map-text");for(var i=0;i<textElements.length;i++){if(state.colorsInverted){textElements[i].classList.add("inverted")}else{textElements[i].classList.remove("inverted")}}}if(backgroundCheckbox.checked!==state.showBackground){state.showBackground=backgroundCheckbox.checked;var textElements=document.getElementsByClassName("map-text");for(var i=0;i<textElements.length;i++){if(state.showBackground){textElements[i].classList.remove("nobg")}else{textElements[i].classList.add("nobg")}}}}e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}},{id:"help-button",icon:"fa-question",tooltip:content.helpTooltip,clickFn:function(){map.openModal({template:content.helpModalTemplate,onShow:function(e){L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){e.modal.hide()})}})}}]});map.addControl(helpSettingsToolbar);var importExportToolbar=new L.Control.CustomToolbar({position:"bottomleft",buttons:[{id:"import-button",icon:"fa-upload",tooltip:content.importTooltip,clickFn:function(){map.openModal({template:content.importModalTemplate,onShow:function(e){var importInput=document.getElementById("import-file");importInput.focus();var fileContent;L.DomEvent.on(importInput,"change",function(evt){var reader=new window.FileReader;reader.onload=function(evt){if(evt.target.readyState!==2){return}if(evt.target.error){window.alert("Error while reading file");return}fileContent=evt.target.result};reader.readAsText(evt.target.files[0])});L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){var saveData=JSON.parse(fileContent);importMapState(saveData);e.modal.hide();fitViewToMission()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})},onHide:function(){checkButtonsDisabled()}})}},{id:"export-button",icon:"fa-download",tooltip:content.exportTooltip,clickFn:function(){if(!mapIsEmpty()){util.download("plan_IL2MPR_r"+EXPORT_REV+".json",JSON.stringify(exportMapState()))}}},{id:"export-excel-button",icon:"fa-file-excel-o",tooltip:content.exportCSVTooltip,clickFn:function(){if(!mapIsEmpty()&&util.flightPlanPresent(drawnItems)){util.download("csv_IL2MPR_r"+EXPORT_REV+".csv",util.csvConvert(exportMapToCSV()))}}},{id:"stream-button",icon:"fa-share-alt",tooltip:content.streamTooltip,clickFn:function(){var template;if(!state.streaming&&!state.connected){template=content.streamModalTemplate;fireStreamModal()}else if(state.streaming&&!state.connected){template=content.alreadyStreamingModalTemplate;fireAlreadyStreamingModal()}else if(!state.streaming&&state.connected){template=content.alreadyConnectedModalTemplate;fireAlreadyConnectedModal()}function fireStreamModal(){if(conf.streaming===true){map.openModal({template:template,onShow:function(e){document.getElementById("stream-start-button").focus();L.DomEvent.on(document.getElementById("stream-start-button"),"click",function(){e.modal.hide();fireStartModal()});L.DomEvent.on(document.getElementById("stream-connect-button"),"click",function(){e.modal.hide();fireConnectModal()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}}function fireStartModal(){map.openModal({template:content.startStreamModalTemplate,onShow:function(e){document.getElementById("stream-start-confirm-button").focus();L.DomEvent.on(document.getElementById("stream-start-confirm-button"),"click",function(){var streamName=document.getElementById("stream-name").value;var streamPassword=document.getElementById("stream-password").value;var streamCode=document.getElementById("stream-leader-code").value;if(!streamName||!streamPassword||!streamCode){var errorElement=document.getElementById("start-stream-error");errorElement.innerHTML="All fields are required. Try again.";util.removeClass(errorElement,"hidden-section");return}var mapState=window.escape(JSON.stringify(exportMapState()));var response=webdis.startStream(streamName,streamPassword,streamCode,mapState);if(response[0]!=="SUCCESS"){var errorElement=document.getElementById("start-stream-error");errorElement.innerHTML=response[1];util.removeClass(errorElement,"hidden-section");return}state.streaming=true;util.addClass(document.querySelector("a.fa-share-alt"),"streaming");state.streamInfo={name:streamName,password:streamPassword,code:streamCode};e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}function fireConnectModal(){map.openModal({template:content.connectStreamModalTemplate,onShow:function(e){var streamSelect=document.getElementById("stream-select");var streams=webdis.getStreamList();streamSelect.options.length=0;for(var i=0;i<streams.length;i++){streamSelect.options[i]=new Option(streams[i].substring(7),streams[i].substring(7))}setupCheckboxTogglableElement("leader-checkbox","leader-hidden");document.getElementById("stream-connect-button").focus();L.DomEvent.on(document.getElementById("stream-connect-button"),"click",function(){var selectedStream=streamSelect.options[streamSelect.selectedIndex].value;var password=document.getElementById("stream-password").value;var code,response;var checkbox=document.getElementById("leader-checkbox");if(checkbox.checked){if(V.fails("connect-form")){var errorElement=document.getElementById("connect-stream-error");errorElement.innerHTML="Password and code are required to connect.";util.removeClass(errorElement,"hidden-section");return}code=document.getElementById("stream-code").value;response=webdis.getStreamReconnect(selectedStream,password,code);if(response[0]!=="SUCCESS"){var errorElement=document.getElementById("connect-stream-error");errorElement.innerHTML=response[1];util.removeClass(errorElement,"hidden-section");return}state.streamInfo.code=code;clearMap();importMapState(JSON.parse(response[2]));state.streaming=true;util.addClass(document.querySelector("a.fa-share-alt"),"streaming")}else{if(V.fails("connect-form")){var errorElement=document.getElementById("connect-stream-error");errorElement.innerHTML="Password is required to connect.";util.removeClass(errorElement,"hidden-section");return}response=webdis.getStreamInfo(selectedStream,password);if(response[0]!=="SUCCESS"){var errorElement=document.getElementById("connect-stream-error");errorElement.innerHTML=response[1];util.removeClass(errorElement,"hidden-section");return}webdis.subscribe(response[1]);clearMap();importMapState(JSON.parse(response[2]));state.connected=response[1];util.addClass(document.querySelector("a.fa-share-alt"),"connected");startConnectedMode()}state.streamInfo={name:selectedStream,password:password,code:code};checkButtonsDisabled();e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}function fireAlreadyConnectedModal(){map.openModal({streamName:state.streamInfo.name,template:content.alreadyConnectedModalTemplate,onShow:function(e){document.getElementById("disconnect-button").focus();L.DomEvent.on(document.getElementById("disconnect-button"),"click",function(){webdis.unsubscribe(state.connected);state.connected=false;util.removeClass(document.querySelector("a.fa-share-alt"),"connected");endConnectedMode();e.modal.hide()});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}function fireAlreadyStreamingModal(){map.openModal({streamName:state.streamInfo.name,streamPassword:state.streamInfo.password,streamCode:state.streamInfo.code,template:content.alreadyStreamingModalTemplate,onShow:function(e){document.getElementById("stop-streaming-button").focus();setupCheckboxTogglableElement("already-streaming-checkbox","already-streaming-hidden");L.DomEvent.on(document.getElementById("stop-streaming-button"),"click",function(){e.modal.hide();state.streaming=false;util.removeClass(document.querySelector("a.fa-share-alt"),"streaming")});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}}}]});map.addControl(importExportToolbar);var gridToolbar=new L.Control.CustomToolbar({position:"topleft",buttons:[{id:"gridhop-button",icon:"fa-th-large",tooltip:content.gridHopTooltip,clickFn:function(){map.openModal({template:content.gridJumpModalTemplate,onShow:function(e){var gridElement=document.getElementById("grid-input");gridElement.focus();L.DomEvent.on(e.modal._container.querySelector(".modal-ok"),"click",function(){if(V.passes("grid-jump-form")){var grid=gridElement.value;var viewLatLng=calc.gridLatLng(grid,mapConfig);map.flyTo(viewLatLng,mapConfig.gridHopZoom);e.modal.hide()}else{var errorElement=document.getElementById("grid-jump-error");errorElement.innerHTML="Please input a valid four digit grid number.";util.removeClass(errorElement,"hidden-section");errorElement.focus()}});L.DomEvent.on(e.modal._container.querySelector(".modal-cancel"),"click",function(){e.modal.hide()})}})}},{id:"missionhop-button",icon:"fa-crop",tooltip:content.missionHopTooltip,clickFn:function(){if(!mapIsEmpty()){fitViewToMission()}}}]});map.addControl(gridToolbar);map.on("draw:created",function(e){drawnItems.addLayer(e.layer);if(e.layerType==="polyline"){applyFlightPlan(e.layer)}else if(e.layerType==="marker"){applyTargetInfo(e.layer)}else if(e.layerType==="circle"){applyCircle(e.layer)}else if(e.layerType==="polygon"){applyPolygon(e.layer)}checkButtonsDisabled()});map.on("draw:deleted",function(e){deleteAssociatedLayers(e.layers);publishMapState();checkButtonsDisabled()});map.on("draw:edited",function(e){deleteAssociatedLayers(e.layers);e.layers.eachLayer(function(layer){if(layer instanceof L.Polygon){}else if(layer instanceof L.Polyline){if(layer.isFlightPlan){layer.wasEdited=layer.getLatLngs().length-1!==layer.speeds.length;applyFlightPlanCallback(layer)}}else if(layer instanceof L.Circle){}else if(layer instanceof L.Marker){applyTargetInfoCallback(layer)}});publishMapState()});map.on("draw:editstart",function(){state.changing=true;hideChildLayers()});map.on("draw:editstop",function(){state.changing=false;drawnItems.eachLayer(function(layer){if(layer instanceof L.Marker){if(L.DomUtil.hasClass(layer._icon,"leaflet-edit-marker-selected")){L.DomUtil.removeClass(layer._icon,"leaflet-edit-marker-selected");util.offsetMarker(layer._icon,-4)}}});showChildLayers();checkButtonsDisabled()});map.on("draw:deletestart",function(){state.changing=true;hideChildLayers()});map.on("draw:deletestop",function(){state.changing=false;showChildLayers();checkButtonsDisabled()});window.addEventListener("il2:streamerror",function(e){if(!state.connected){return}util.addClass(document.querySelector("a.fa-share-alt"),"stream-error")});window.addEventListener("il2:streamupdate",function(e){if(!state.connected){return}var saveData=e.detail;if(saveData!==1){clearMap();importMapState(JSON.parse(saveData))}util.removeClass(document.querySelector("a.fa-share-alt"),"stream-error");checkButtonsDisabled()});checkButtonsDisabled()})()},{"./calc.js":1,"./content.js":2,"./controls.js":3,"./icons.js":4,"./util.js":6,"./webdis.js":7}],6:[function(require,module,exports){module.exports=function(){var calc=require("./calc.js");const UNIT_MAP={metric:{distance:"km",speed:"kph",altitude:"m"},imperial:{distance:"mi",speed:"mph",altitude:"ft"}};return{formatTime:function(timeInSeconds){var minutes=timeInSeconds/60;var seconds=timeInSeconds%60;return Math.floor(minutes).toFixed(0)+":"+calc.pad(seconds,2)},isAvailableMapHash:function(hash,maps){for(var map in maps){if(maps[map].hash===hash){return true}}return false},getSelectedMapConfig:function(hash,maps){for(var map in maps){if(maps[map].hash===hash){return maps[map]}}return maps.stalingrad},defaultPopulateArray:function(val,count){var array=[];for(var i=0;i<count;i++){array.push(parseInt(val))}return array},formatFlightLegMarker:function(distance,heading,speed,time,units){units=units||"metric";distance=typeof distance==="number"?distance.toFixed(1):distance;heading=typeof heading==="number"?heading.toFixed(0):heading;var textRotation=heading%180-90;return'<div style="background: rgba(100, 100, 100, .75); transform: rotate('+textRotation+'deg);">'+distance+UNIT_MAP[units].distance+" | "+calc.pad(heading,3)+"&deg;/"+calc.pad(calc.invertHeading(heading),3)+"&deg; <br/> "+speed+UNIT_MAP[units].speed+" | "+"ETE "+time+"</div>"},formatFlightStartMarker:function(name,altitude,units){units=units||"metric";return name+"<br />"+altitude+UNIT_MAP[units].altitude},formatFlightTurnMarker:function(altitude,units){units=units||"metric";return Math.round(altitude)+UNIT_MAP[units].altitude},bindPicture:function(url,layer){var popupContent=document.createElement("img");popupContent.onload=function(){layer.update()};popupContent.src=url;popupContent.width=700;layer.bindPopup(popupContent,{className:"popup",maxWidth:"710px",closeButton:false})},validUrl:function(string){var url=require("url");var result;try{result=url.parse(string)}catch(_){return false}return result.protocol==="http:"||result.protocol==="https:"},buildGetXhr:function(url,updateFn){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.onreadystatechange=updateFn;xhr.send(null);return xhr},buildGetBlobXhr:function(url,updateFn){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.responseType="blob";xhr.onreadystatechange=updateFn;xhr.send();return xhr},buildSyncGetXhr:function(url){var xhr=new XMLHttpRequest;xhr.open("GET",url,false);xhr.send(null);return xhr},hasClass:function(el,className){if(el.classList){return el.classList.contains(className)}else{return!!el.className.match(new RegExp("(\\s|^)"+className+"(\\s|$)"))}},addClass:function(el,className){if(el.classList){el.classList.add(className)}else if(!this.hasClass(el,className)){el.className+=" "+className}},removeClass:function(el,className){if(el.classList){el.classList.remove(className)}else if(this.hasClass(el,className)){var reg=new RegExp("(\\s|^)"+className+"(\\s|$)");el.className=el.className.replace(reg," ")}},download:function(filename,text){var pom=document.createElement("a");pom.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(text));pom.setAttribute("download",filename);if(document.createEvent){var event=document.createEvent("MouseEvents");event.initEvent("click",true,true);pom.dispatchEvent(event)}else{pom.click()}},csvConvert:function(array){var csv="";for(var i=0;i<array.length;i++){var row=array[i];var string="";for(var index in row){var w=row[index];string+=w;if(index!==row.length-1){string+=","}}string+="\n";csv+=string}return csv},flightPlanPresent:function(layer){var present=false;layer.eachLayer(function(e){if(e instanceof L.Polyline&&!(e instanceof L.Polygon)){if(e.isFlightPlan){present=true}}});return present},offsetMarker:function(icon,offset){var iconMarginTop=parseInt(icon.style.marginTop,10)-offset,iconMarginLeft=parseInt(icon.style.marginLeft,10)-offset;icon.style.marginTop=iconMarginTop+"px";icon.style.marginLeft=iconMarginLeft+"px"},fixOldLatLng:function(latLng,mapConfig,revision){if(typeof revision==="undefined"||revision<2){latLng.lat=latLng.lat-Math.abs(mapConfig.latMax-mapConfig.latMin)+mapConfig.oldLatFixFactor}return latLng},fixOldLatLngs:function(latLngs,mapConfig,revision){if(typeof revision==="undefined"||revision<2){for(var i=0;i<latLngs.length;i++){latLngs[i][0]=latLngs[i][0]-Math.abs(mapConfig.latMax-mapConfig.latMin)+mapConfig.oldLatFixFactor}}return latLngs}}}()},{"./calc.js":1,url:13}],7:[function(require,module,exports){module.exports=function(){var fs=require("fs");var util=require("./util.js");var conf=JSON.parse('{\n  "apiUrl"    : "NONE",\n  "serverUrl" : "https://www.example.com",\n  "tilesUrl"  : "https://www.example.com/tiles",\n  "streaming" : false,\n  "webdisUrl" : "https://www.example.com/WEBDIS"\n}');const WEBDIS_HOST=conf.webdisUrl;return{scripts:{getChannel:"",publishState:"",newStream:"",getReconnect:""},init:function(){var requiredKeys=Object.keys(this.scripts);var response=this.hmget("scripts",requiredKeys);if(response.length!==requiredKeys.length){return false}for(var i=0;i<response.length;i++){this.scripts[requiredKeys[i]]=response[i]}return true},publish:function(stream,password,code,state){var url=this._buildEvalshaUrl(this.scripts.publishState,[stream,password,code,state]);var xhr=util.buildGetXhr(url,function(){if(xhr.readyState===4){var responseBody=JSON.parse(xhr.responseText).EVALSHA;if(responseBody[0]!=="SUCCESS"){this._errorHandler()}}})},hmget:function(key,fields){var url=this._buildHmgetUrl(key,fields);var response=util.buildSyncGetXhr(url);return JSON.parse(response.responseText).HMGET},subscribe:function(channel){var prev_length=0;var url=this._buildSubscribeUrl(channel);var xhr=util.buildGetXhr(url,function(){if(xhr.readyState===3){var response=xhr.responseText;try{var chunk=JSON.parse(response.slice(prev_length));if(!chunk||typeof chunk!=="object"){this._errorHandler()}}catch(e){this._errorHandler()}var newState=chunk.SUBSCRIBE[2];prev_length=response.length;var evt=new CustomEvent("il2:streamupdate",{detail:newState});window.dispatchEvent(evt)}})},unsubscribe:function(channel){var url=this._buildUnsubscribeUrl(channel);util.buildGetXhr(url,function(){})},getStreamList:function(){var url=this._buildKeysUrl("stream:*");var response=util.buildSyncGetXhr(url);return JSON.parse(response.responseText).KEYS},getStreamInfo:function(stream,password){var url=this._buildEvalshaUrl(this.scripts.getChannel,[stream,password]);var response=util.buildSyncGetXhr(url);return JSON.parse(response.responseText).EVALSHA},getStreamReconnect:function(stream,password,code){var url=this._buildEvalshaUrl(this.scripts.getReconnect,[stream,password,code]);var response=util.buildSyncGetXhr(url);return JSON.parse(response.responseText).EVALSHA},startStream:function(name,password,code,state){var url=this._buildEvalshaUrl(this.scripts.newStream,[name,password,code,state]);var response=util.buildSyncGetXhr(url);return JSON.parse(response.responseText).EVALSHA},_buildEvalshaUrl:function(hash,args){var url=WEBDIS_HOST+"/EVALSHA/"+hash+"/0";for(var i=0;i<args.length;i++){url+="/"+args[i]}return url},_buildHmgetUrl:function(key,fields){var url=WEBDIS_HOST+"/HMGET/"+key;for(var i=0;i<fields.length;i++){url+="/"+fields[i]}return url},_buildKeysUrl:function(pattern){return WEBDIS_HOST+"/KEYS/"+pattern},_buildSubscribeUrl:function(channel){return WEBDIS_HOST+"/SUBSCRIBE/"+channel},_buildPublishUrl:function(channel,value){return WEBDIS_HOST+"/PUBLISH/"+channel+"/"+value},_buildUnsubscribeUrl:function(channel,value){return WEBDIS_HOST+"/UNSUBSCRIBE/"+channel},_errorHandler:function(){var evt=new CustomEvent("il2:streamerror");window.dispatchEvent(evt)}}}()},{"./util.js":6,fs:8}],8:[function(require,module,exports){},{}],9:[function(require,module,exports){(function(global){(function(){(function(root){var freeExports=typeof exports=="object"&&exports&&!exports.nodeType&&exports;var freeModule=typeof module=="object"&&module&&!module.nodeType&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^\x20-\x7E]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw new RangeError(errors[type])}function map(array,fn){var length=array.length;var result=[];while(length--){result[length]=fn(array[length])}return result}function mapDomain(string,fn){var parts=string.split("@");var result="";if(parts.length>1){result=parts[0]+"@";string=parts[1]}string=string.replace(regexSeparators,".");var labels=string.split(".");var encoded=map(labels,fn).join(".");return result+encoded}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.4.1",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define("punycode",function(){return punycode})}else if(freeExports&&freeModule){if(module.exports==freeExports){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],10:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],11:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],12:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":10,"./encode":11}],13:[function(require,module,exports){"use strict";var punycode=require("punycode");var util=require("./util");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=["<",">",'"',"`"," ","\r","\n","\t"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var queryIndex=url.indexOf("?"),splitter=queryIndex!==-1&&queryIndex<url.indexOf("#")?"?":"#",uSplit=url.split(splitter),slashRegex=/\\/g;uSplit[0]=uSplit[0].replace(slashRegex,"/");url=uSplit.join(splitter);var rest=url;rest=rest.trim();if(!slashesDenoteHost&&url.split("#").length===1){var simplePath=simplePathPattern.exec(rest);if(simplePath){this.path=rest;this.href=rest;this.pathname=simplePath[1];if(simplePath[2]){this.search=simplePath[2];if(parseQueryString){this.query=querystring.parse(this.search.substr(1))}else{this.query=this.search.substr(1)}}else if(parseQueryString){this.search="";this.query={}}return this}}var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf("@")}else{atSign=rest.lastIndexOf("@",hostEnd)}if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth)}hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||"";var ipv6Hostname=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}this.hostname=validParts.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!ipv6Hostname){this.hostname=punycode.toASCII(this.hostname)}var p=this.port?":"+this.port:"";var h=this.hostname||"";this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];if(rest.indexOf(ae)===-1)continue;var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query)}rest=rest.slice(0,qm)}else if(parseQueryString){this.search="";this.query={}}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var p=this.pathname||"";var s=this.search||"";this.path=p+s}this.href=this.format();return this};function urlFormat(obj){if(util.isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format()}Url.prototype.format=function(){var auth=this.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=false,query="";if(this.host){host=auth+this.host}else if(this.hostname){host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){host+=":"+this.port}}if(this.query&&util.isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query)}var search=this.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)});search=search.replace("#","%23");return protocol+host+pathname+search+hash};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative)}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format()};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative)}Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url;rel.parse(relative,false,true);relative=rel}var result=new Url;var tkeys=Object.keys(this);for(var tk=0;tk<tkeys.length;tk++){var tkey=tkeys[tk];result[tkey]=this[tkey]}result.hash=relative.hash;if(relative.href===""){result.href=result.format();return result}if(relative.slashes&&!relative.protocol){var rkeys=Object.keys(relative);for(var rk=0;rk<rkeys.length;rk++){var rkey=rkeys[rk];if(rkey!=="protocol")result[rkey]=relative[rkey]}if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname="/"}result.href=result.format();return result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){var keys=Object.keys(relative);for(var v=0;v<keys.length;v++){var k=keys[v];result[k]=relative[k]}result.href=result.format();return result}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");result.pathname=relPath.join("/")}else{result.pathname=relative.pathname}result.search=relative.search;result.query=relative.query;result.host=relative.host||"";result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||"";var s=result.search||"";result.path=p+s}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==="/",isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname="";result.port=null;if(result.host){if(srcPath[0]==="")srcPath[0]=result.host;else srcPath.unshift(result.host)}result.host="";if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}relative.host=null}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){result.host=relative.host||relative.host===""?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===""?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query}else if(!util.isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}result.search=relative.search;result.query=relative.query;if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.href=result.format();return result}if(!srcPath.length){result.pathname=null;if(result.search){result.path="/"+result.search}else{result.path=null}result.href=result.format();return result}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host||srcPath.length>1)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last==="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}if(!srcPath.length){result.pathname=null;result.path=null}else{result.pathname=srcPath.join("/")}if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){this.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)this.hostname=host}},{"./util":14,punycode:9,querystring:12}],14:[function(require,module,exports){"use strict";module.exports={isString:function(arg){return typeof arg==="string"},isObject:function(arg){return typeof arg==="object"&&arg!==null},isNull:function(arg){return arg===null},isNullOrUndefined:function(arg){return arg==null}}},{}]},{},[5]);